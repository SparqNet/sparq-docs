# 2.4 - Database

The **DB** class, declared in `utils/db.h`, is an abstraction of the internal database used by Sparq. The database itself is an abstraction of a [LevelDB](https://github.com/google/leveldb) database (which is used internally) - a simple key/value database, but handled in a different way: keys use *prefixes*, which makes it possible to batch read and write, so we can get around LevelDB's own limitations.

## Structs and Prefixes

We have three helper structs to ease database manipulation:

* **DBServer** - struct that contains the host and version of the database that will be connected to
* **DBEntry** - struct that contains an entry to be inserted or read by the database, has only two members: key and value, both strings
* **DBBatch** - struct that contains multiple `DBEntry`s to be inserted and/or deleted all at once

We also have a **DBPrefix** namespace to reference the database's prefixes in a simpler way:

```
0001 = DBPrefix::blocks -- Key: Block Hash | Value: Block
0002 = DBPrefix::blockHeightMaps -- Key: Block Height | Value: Block Hash
0003 = DBPrefix::nativeAccounts -- Key: Address | Value: Native Balance + Native Nonce
0004 = DBPrefix::erc20Tokens -- ERC20 Tokens/State (TODO)
0005 = DBPrefix::erc721Tokens -- ERC721 Tokens/State (TODO)
0006 = DBPrefix::TxToBlocks -- Key: Tx Hash | Value: Block Hash
0007 = DBPrefix::validators -- TODO
0008 = DBPrefix::contracts -- TODO
0009 = DBPrefix::rdPoS -- TODO
```

Those prefixes are concatenated to the start of the *key*, so an entry that would have, for example, a key named "abc" and a value of "123", if inserted to the "0003" prefix, would be like this inside the database: `{"0003abc": "123"}`

## How to manipulate the database

The **DB** class requires a filesystem path to open the database (if it exists) or create it on the spot (if it doesn't exist) during construction. To close the database, call the `close()` function.

For the main CRUD operations, refer to the `has()`, `get()`, `put()` and `del()` functions. There are also `getBatch()` and `putBatch()` for batched operations, and a helper function called `stripPrefix()` that removes the prefix from a given key (e.g. key "0003abc" with value "123", `stripPrefix(key)` would return "abc").

Due to the way LevelDB works, updating an entry is the same as inserting a different value in a key that already exists - e.g. `put(oldKey, newValue)`.

